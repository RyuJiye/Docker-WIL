# 컨테이너 서비스
## 컨테이너 서비스란?
컨테이너의 사전적 의미는 어떤 사물을 격리할 수 있는 공간을 뜻합니다. 즉, **컨테이너에 우리가 서비스하고자 하는 애플리케이션 코드와 프로세스를 격리한다**는 의미로 해석할 수 있습니다. 애플리케이션 개발 환경이 도커 기반의 컨테이너 서비스 환경으로 전환된 이유는 무엇일까요? 가변적 인프라 환경으로 인해 일관성 없는 환경이 제공되기 때문에 대분의 개발자는 개발 외의 문제들에 많은 시간을 쏟는다는 문제가 있었습니다. 그래서 가ㅇ화 방식을 통해서 애플리케이션이 가지고 있는 운영체제, 하드웨어에 대한 의존성 문제를 해결했습니다.

- 하드웨어 레벨 가상화: 하이퍼바이저 등을 이용한 가상머신의 방식
- 운영체제 레벨 가상화: 컨테이너 기반의 애플리케이션 서비스 방식

# 왜 도커 컨테이너 서비스일까?
먼저 도커를 이용한 컨테이너 애플리케이션 서비스 개발이 이루어지는 일반적인 과정에 대해서 알아보자.

1. 애플리케이션 코드 개발: 특정 서비스 구동을 위한 애플리케이션 코드 및 웹 화면 구성 등을 위한 코드를 개발
2. 베이스 이미지를 이용한 Dockerfile 작성: 개발에 필요한 인프라 구성 요소를 Dockerfile에 작성
3. Dockerfile build를 통한 새로운 이미지 생성: docker build 명령을 통해 작성한 Dockerfild을 실행 
4. 1. 생성된 이미지를 이용한 컨테이너 실행: docker images를 통해 생성된 이미지를 확인하고 이미지를 통한 컨테이너 구동
    2. 도커 컴포즈를 이용한 다중 컨테이너 실행: docker-compse.yml을 통해 다중 컨테이너 간 실행 순서, 네트워크, 의존성 등을 통합 관리

5.  1. 컨테이너 애플리케이션 서비스 테스트: IP와 포트 번호를 이용하여 웹 브라우저를 이용한 페이지 연결 확인
    2. 마이크로서비스(MSA) 테스트
6. 로컬 및 원격 저장소에 이미지 저장: 로컬 및 원격에 있는 이미지 저장소에 생성한 이미지 저장
7. 깃허브 등을 활용한 Dockerfile 관리: Dockerfile을 깃허브 사이트에 저장 및 관리할 수 있고, 도커 허브 사이트와 연동하게 되면 자동화된 빌드 기능을 이용한 이미지 생성 가능
8. 동일 환경에서의 지속적 애플리케이션 개발 수행

IaC(Infarstructure as Code)란 컨테이너 동작에 필요한 모든 내용을 사전에 코드로 작성하여 자동화하게 되면 필요할 때마다 애플리케이션 및 서버 환경을 적은 비용으로 빠르게 개발, 배포, 확장할 수 있다는 것을 말합니다. 이로 인해 개발자는 변경 불가능한 인프라 환경에서 언제든 동일한 상태에서의 개발이 가능해졌습니다.

# 도커 명령어 활용
## 도커 이미지 명령어
도커 컨테이너는 이비지 기반으로 실행된다. 그렇기에 도커 이미지는 도커의 핵심 기술이며 코드로 개발된 컨테이너 내부 환경 정보를 복제할 수 있다.

### 도커 이미지 내려받기
- docker pull: 도커 허브 레지스트리에서 로컬로 도커 이미지 내려받기

```linux
docker [image] pull [OPTIONS] name[:TAGE | @IMAGES_DIGEST]
```

|옵션명(단축명)|설명
|----|----
--all-tags, -a| 저장소에 태그로 저장된 여러 이미지를 모두 다운로드
--disable-content-trust| 이미지 검증 작업 건너뛰기, DCT를 이용한 이미지 신뢰성 검증, 작업으로 DOCKER_CONTENT_TRUST=1로 활성화
--platform|플랫폼 지정, 윈도우 도커에서 리눅스 이미지를 받아야 하는 경우 사용
--quiet, -q| 이미지 다운로드 과정에서 화면에 나타나는 상세 출력 숨김

- docker push: 로컬에 있는 도커 이미지를 도커 허브 레지스트리에 업로드
- docker login: 업로드 하기 전 도커 허브 계정 로그인
- docker logout: 도커 허브에서 로그아웃

### 도커 이미지 세부 정보 조회
- docker image inspect

```linux
docker image inspect [OPTIONS] IMAGE [IMAGE...]
```

|옵션명(단축명)|설명
|----|----
--format, -f| JSON 형식의 정보 중 지정한 형식의 정보만 출력할 수 있고, {} 중괄호 형식과 대소문자에 유의

- docker image history: 현재 이미지 구성을 위해 사용된 레이블 정보와 각 레리어의 수행 명령, 크기 등을 조회

```linux
docker image history [OPTIONS] IMAGE
```

### 도커 이미지 태그 설정과 도커 로그인 및 로그아웃
- docker tag

```linux
docker tage 원본 이미지[:태그] 참조 이미지[:태그]
```

- docker login
- docker logout

### 도커 이미지를 파일로 관리
- docker image save: 도커 원본 이미지의 레이어 구조까지 포함한 복제를 수행하여 tar 파일로 이미지 저장

```linux
# 도커 이미지 tar 파일로 저장
docker image save [옵션] <파일명> [image 명]

# tar 파일을 이미지로 불러옴
docker image load [옵션]
```

docker image save 명령어는 언제 사용할까?

- 도커 허브로부터 이미지를 내려받아 내부망으로 이전하는 경우
- 신규 애플리케이션 서비스를 위해 Dockerfile로 새롭게 생성한 이미지를 저장 및 배포해야 하는 경우
- 컨테이너를 commit하여 생성한 이미지를 저장 및 배포해야 하는 경우
- 개발 및 수정한 이미지 등

### 도커 이미지 삭제
```linux
docker image rm [옵션] {이미지 이름[:태그] | 이미지 ID}

docker rmi [옵션] {이미지 이름[:태그] | 이미지 ID}
```

- docker image prune: 컨테이너와 연결되지 않은 모든 이미지를 제거

## 도커 컨테이너 명령어
<img src="https://github.com/leeedohyun/Docker-WIL/assets/116694226/bce91b04-d75b-4d34-b72b-fb30531e6eb5" width=500>

### 컨테이너는 프로세스이다
도커 컨테이너는 도커 이미지를 기반으로 만들어지는 스냅샷이다. 이 스냅샷은 읽기 전용의 도커 이미지 레이어를 복제한 것이고, 그 위에 읽고 쓰기가 가능한 컨테이너 레이어를 결합하면 컨테이너가 된다.

컴퓨터 애플리케이션의 동작은 프로세스를 통해 이루어진다. 컨테이너는 프로세스 격리 기술의 표준으로 정의된 OCI로 컨테이너 포맷과 런타임에 대한 개방형 업계 표준을 만들기 위한 목적으로 리눅스 파운데이션의 지원을 받아 구성된 오픈 프로젝트이다. 

### 컨테이너 실행
- docker run: 컨테이너 실행(pull + create + start)

|옵션명(단축명)|설명
|----|----
-i, -interactive| 대화식 모드 열기
-t| TTY 할당
-d, --detach=true| 백그라운드에서 컨테이너 실행 후 컨테이너 ID 등록
--name| 실행되는 컨테이너에 이름 부여
--rm| 컨테이너 종료 시 자동으로 컨테이너 제거
--restart| 컨테이너 종료 시 자동으로 컨테이너 제거
--env| 컨테이너 환경 변수 지정
-v, --volume=호스트 경로:컨테이너 경로| 호스트 경로와 컨테이너 경로의 공유 볼륨 설정
-h| 컨테이너의 호스트명 지정
-p [Host port]:[Container prot], --publish| 호스트 포트와 컨테이너 포트 연결
-P, --publish-all=[true | false]| 컨테이너 내부의 노출된 포트를 호스트 임의의 포트에 게시
--link=[container:container_id]| 동일 호스트의 컨테이너와 연결 설정으로 IP가 아닌 컨테이너의 이름을 이용해 통신

- docker ps: 실행된 컨테이너 조회
- cAdvisor: 컨테이너 모니터링 도구

## 도커 볼륨 환경
도커는 유니온 파일 시스템을 사용한다. 유니온 파일 시스템은 하나의 이미지로부터 여러 컨테이너를 만들 수 있는 방법을 제공하고, 이미지에 변경된 내용을 저장할 수 있도록 해준다. 도커 볼륨은 데이터베이스, 웹 프로그램 등 업무에서 사용하는 애플리케이션에서 발생하는 데이터에 접근하고 공유하기 위해서 도커 볼륨 기능을 사용할 수 있다.

도커 볼륨은 컨테이너에서 생성, 재사용할 수 있고 호스트 운영체제에서 직접 접근이 가능하다. 또한 보존되어야 하는 데이터를 유지하기 위한 메커니즘을 제공한다.

### 도커 볼륨 타입
<img src="https://github.com/leeedohyun/Docker-WIL/assets/116694226/08c441bc-dd28-4670-b7c8-a60874a1bad8
" width=500>

1. volume
- 도커에서 권장하는 방법으로 **docker volume create 볼륨 이름**을 통해 볼륨 생성
- 도커 볼륨은 도커 명령어를 통해 관리
- 여러 컨테이너 간에 안전하게 공유 가능
- 볼륨 드라이버를 통해 원격 호스트 및 클라우드 환경에 볼륨 내용을 저장하고 암호화 가능
- 새 볼륨으로 지정될 영역에 데이터를 미리 채우고 컨테이너에 연결하면 컨테이너 내에서 바로 데이터 사용 가능

2. bind mount
- 도커 볼륨 기법에 비해 사용이 제한적
- 호스트 파일 시스템 절대 경로: 컨테이너 내부 경로를 직접 마운트하여 사용
- 사용자가 파일 또는 디렉터리를 생성하면 해당 호스트 파일 시스템의 소유자 권한으로 연결이 되고, 존재하지 않는 경우 자동 생성
- 컨테이너 실행 시 지정하여 사용하고, 컨테이너 제거 시 바인드 마운트는 해제되지만 호스트 디렉터리는 유지

3. tmpfs mount
- 임시적이며 호스트 메모리에서만 지속되므로 컨테이너가 종료되면 제거되고 내부에 기록된 파일은 유지되지 않음
- 호스트 또는 컨테이너 쓰기 가능 계층에서 지속하지 않지만 중요한 파일을 임시로 사용하는 방법에 유용
- 컨테이너 실행 시 지정하여 사용하고, 컨테이너 제거 시 자동 해제

## 도커 컨테이너의 자원 사용에 대한 런타임 제약
### 서버 자원 모니터링
서버 시스템을 운영하면서 자원의 사용량이나 활용도를 모니터링해야 한다. 

### 컨테이너 리소스 런타임 제약 옵션
도커는 CPU, 메모리, 디스크 I/O에 대하여 런타임 제약 옵션을 제공한다.

## 도커 네트워크
### 도커 네트워크 개요
도커 컨테이너 및 서비스는 도커 네트워크를 통해 격리된 컨테이너 간의 네트워크 연결뿐만 아니라 도커 외의 다른 애플리케이션 워크로드와도 연결이 가능하다.

<img src="https://github.com/leeedohyun/Docker-WIL/assets/116694226/b9940f1e-5a60-42ae-bfb5-f4c8be70a087" width=500>

여기서 제공되는 네 가지 네트워크 인터페이스를 알아보자.

- enp0s8: Ubuntu 리눅스의 네트워크 가드
- docker0: 도커 설치 시 기본적으로 제공되는 브릿지 네트워크
- vethxxxxxxx: OSI 7 계층 서비스 모델의 2계층 서비스로 컨테이너 내부에 제공되는 네트워크 인터페이스 eth0와 한 쌍으로 제공되어 docker0와 가상의 터널링 네트워크 제공
- eth0: 도커 컨테이너에 생성되는 기본 네트워크 인터페이스명으로 docker0를 게이트웨이로 사용

### 도커 사용자 정의 네트워크 활용
1. --net-alias와 도커 DNS 서비스를 활용한 부하 분산
docker run 수행 시 `--net-alias` 또는 `--link` 옵션으로 묶인 모든 컨테이너에는 기본적으로 서비스를 검색할 수 있는 내장 DNS 서버가 제공된다. 이를 자동화 DNS 확인이라고 한다.

2. nginx를 이용한 컨테이너 로드 밸런스 구축
도커는 외부 서비스와 부하를 분산시키기 위하여 로드 밸런스를 구축할 수 있다.

|연결 알고리즘| 설명
|-----|-----
라운드-로빈| 클라이언트 요청을 서버 가중치를 고려하여 구성된 서버에 균등 배분하는 방식
최소 연결| 현재 연결된 클라이언트 수가 가장 적은 서버로 요청 전달
IP 해시| 해시 키를 이용하여 IP별 INDEX를 생성하여 동일 IP 주소는 동일 서버로의 경로 보장
일반 해시| 사용자가 정의하는 키를 이용한 서버 지정 방식
최소 시간| 요청에 대한 낮은 평균 지연시간을 기준으로 계산하여 서버 지정
무작위| 요청에 대한 무작위 서버를 선택하며 특정 기준을 두고 부합되는 서버 선택 가능

## 도커 kill 명령과 초기화
도커에서는 docker stop 명령어를 통해 컨테이너를 종료시킬 수 있고, docker kill 명령어를 사용해서 강제로 종료할 수 있다. 더 이상 사용하지 않는 도커 관련 리소스를 모두 정리할 필요가 있는데, 이때 사용하는 명령어는 `docker system prune`이다.